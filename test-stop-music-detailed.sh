#!/bin/bash

echo "ğŸ§ª =============================================="
echo "ğŸ§ª STOP MUSIC DETAILED TEST"
echo "ğŸ§ª =============================================="
echo ""
echo "This script will help diagnose why stop music isn't working."
echo ""
echo "SETUP:"
echo "1. Backend is already running (PID 41524)"
echo "2. We'll rebuild Flutter with enhanced logging"
echo "3. You'll test stop music"
echo "4. We'll analyze the logs"
echo ""

read -p "Press ENTER to rebuild Flutter app with enhanced logging..."

echo ""
echo "ğŸ“± Rebuilding Flutter app..."
cd frontend_flutter
flutter build macos --debug

if [ $? -ne 0 ]; then
    echo "âŒ Flutter build failed!"
    exit 1
fi

echo ""
echo "âœ… Flutter rebuilt successfully!"
echo ""
echo "================================================"
echo "ğŸ“‹ TEST PROCEDURE:"
echo "================================================"
echo ""
echo "1. Open Spotify Desktop app (if not already open)"
echo "2. Run: open -a Spotify"
echo ""
echo "3. Start the Flutter app in a NEW terminal:"
echo "   cd /Users/robenhai/Never\ Alone/frontend_flutter"
echo "   flutter run -d macos"
echo ""
echo "4. In the app, start a conversation and say:"
echo "   \"×ª× ×’×Ÿ ×œ×™ ××•×–×™×§×”\" (play me music)"
echo ""
echo "5. Wait for music to play (Spotify will open)"
echo ""
echo "6. Then say:"
echo "   \"×¢×¦×•×¨ ××ª ×”××•×–×™×§×”\" (stop the music)"
echo ""
echo "7. Watch BOTH terminals (backend + Flutter)!"
echo ""
echo "================================================"
echo "ğŸ” WHAT TO LOOK FOR IN FLUTTER CONSOLE:"
echo "================================================"
echo ""
echo "When you say \"×¢×¦×•×¨ ××ª ×”××•×–×™×§×”\", you should see:"
echo ""
echo "âœ… SUCCESS PATH (if event arrives):"
echo "   ğŸŒ RAW WebSocket Event: \"stop-music\""
echo "   ğŸµğŸµğŸµ STOP-MUSIC EVENT DETECTED IN onAny!"
echo "   ğŸµğŸµğŸµ WebSocketService: ===== STOP MUSIC EVENT RECEIVED ====="
echo "   ğŸµ RealtimeConversationManager: Stop music requested"
echo "   ğŸµğŸµğŸµ ConversationScreen: ===== STOP MUSIC CALLBACK TRIGGERED ====="
echo "   ğŸµğŸµğŸµ ConversationScreen: ===== EXECUTING STOP SPOTIFY PLAYBACK ====="
echo ""
echo "âŒ FAILURE PATH (if event doesn't arrive):"
echo "   (You'll see NONE of the above logs)"
echo "   (Backend will show broadcast, but Flutter shows nothing)"
echo ""
echo "================================================"
echo "ğŸ“Š AFTER TEST:"
echo "================================================"
echo ""
echo "Copy the COMPLETE output from Flutter terminal and share it."
echo "We need to see if the event arrives at all."
echo ""
echo "Key questions to answer:"
echo "1. Did onAny catch the 'stop-music' event? (ğŸŒ RAW WebSocket Event)"
echo "2. Did the specific listener fire? (===== STOP MUSIC EVENT RECEIVED =====)"
echo "3. Did the callback reach the screen? (===== STOP MUSIC CALLBACK TRIGGERED =====)"
echo ""
echo "Good luck! ğŸ€"
echo ""
